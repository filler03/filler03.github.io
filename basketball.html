<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Basketball 2P</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            touch-action: none;
            background: linear-gradient(to bottom, #a08070 0%, #c4a484 50%, #a08070 100%);
            font-family: 'Segoe UI', sans-serif;
        }
        canvas {
            display: block;
        }
        #bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.7) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        #player1-stats {
            color: white;
            pointer-events: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            flex: 1;
        }
        #player1-stats.active {
            background: rgba(255,107,107,0.4);
            box-shadow: 0 0 15px rgba(255,107,107,0.6);
            transform: scale(1.1);
        }
        #player2-stats {
            color: white;
            pointer-events: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
        }
        #player2-stats.active {
            background: rgba(74,158,255,0.4);
            box-shadow: 0 0 15px rgba(74,158,255,0.6);
            transform: scale(1.1);
        }
        #center-display {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            justify-content: center;
        }
        #game-timer-display {
            color: #ffcc00;
            font-family: 'Courier New', monospace;
            font-size: 22px;
            font-weight: bold;
        }
        #half-display {
            color: #888;
            font-size: 12px;
            font-weight: bold;
        }
        #shot-clock-display {
            color: #ff4444;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        #shot-clock-display.warning {
            color: #ff2222;
            animation: blink 0.5s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        .player-name {
            font-size: 12px;
            font-weight: normal;
            display: inline;
        }
        .player-name.p1 { color: #ff6b6b; }
        .player-name.p2 { color: #4a9eff; }
        .player-score {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            display: inline;
            margin-left: 4px;
        }
        @keyframes pulse-grow {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }
        #player1-stats.pulse, #player2-stats.pulse {
            animation: pulse-grow 2s ease-in-out;
        }
        #settings-btn {
            position: absolute;
            top: 9px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
            z-index: 11;
        }
        #settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(30deg);
        }
        #settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
            box-sizing: border-box;
        }
        #settings-modal.open {
            display: flex;
        }
        .modal-content {
            background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
            padding: 30px;
            border-radius: 20px;
            min-width: 300px;
            max-width: 90%;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            margin: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .modal-header h2 {
            color: white;
            margin: 0;
            font-size: 24px;
        }
        .close-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .close-btn:hover {
            color: white;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-label {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #speed-slider {
            width: 100px;
            cursor: pointer;
        }
        #speed-value, #shotclock-value, #halftime-value, #bounce-value {
            color: #ffd700;
            font-weight: bold;
            min-width: 40px;
        }
        .game-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: #1a1a2e;
            margin-top: 15px;
            width: 100%;
            transition: transform 0.2s;
        }
        .game-btn:hover {
            transform: scale(1.02);
        }
        .version-text {
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 12px;
            margin-top: 15px;
        }
        #instructions {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        }

    /* Stats Modal Styles */
    #stats-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 200;
        align-items: center;
        justify-content: center;
        overflow: auto;
    }
    #stats-modal.open {
        display: flex;
    }
    .stats-content {
        background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
        padding: 20px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        margin: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
    }
    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-shrink: 0;
    }
    .stats-header h2 {
        color: #ffd700;
        margin: 0;
        font-size: 22px;
    }
    .stats-summary {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }
    .player-summary {
        text-align: center;
    }
    .player-summary h3 {
        font-size: 14px;
        margin-bottom: 5px;
    }
    .player-summary.p1 h3 { color: #ff6b6b; }
    .player-summary.p2 h3 { color: #4a9eff; }
    .player-summary .big-score {
        font-size: 32px;
        font-weight: bold;
        color: #ffd700;
    }
    .player-summary .stat-line {
        font-size: 12px;
        color: rgba(255,255,255,0.7);
        margin-top: 3px;
    }
    .shot-log-container {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    .shot-log-title {
        color: rgba(255,255,255,0.9);
        font-size: 14px;
        margin-bottom: 10px;
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
        padding: 5px 0;
    }
    .shot-entry {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        border-left: 3px solid;
    }
    .shot-entry.p1 { border-left-color: #ff6b6b; }
    .shot-entry.p2 { border-left-color: #4a9eff; }
    .shot-entry.scored { background: rgba(255,215,0,0.1); }
    .shot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    .shot-player {
        font-weight: bold;
        font-size: 13px;
    }
    .shot-entry.p1 .shot-player { color: #ff6b6b; }
    .shot-entry.p2 .shot-player { color: #4a9eff; }
    .shot-result {
        font-weight: bold;
        font-size: 14px;
    }
    .shot-result.made { color: #00ff88; }
    .shot-result.missed { color: #ff4444; }
    .shot-details {
        font-size: 11px;
        color: rgba(255,255,255,0.6);
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 3px;
    }
    .stats-footer {
        margin-top: 15px;
        flex-shrink: 0;
    }
    .stats-footer .game-btn {
        margin-top: 0;
    }
    .no-shots {
        color: rgba(255,255,255,0.5);
        text-align: center;
        padding: 20px;
        font-style: italic;
    }
    
    /* Game History Modal Styles */
    #history-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 200;
        align-items: center;
        justify-content: center;
        overflow: auto;
    }
    #history-modal.open {
        display: flex;
    }
    .history-content {
        background: linear-gradient(135deg, #2a2a4a 0%, #1a1a2e 100%);
        padding: 20px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        margin: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
    }
    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-shrink: 0;
    }
    .history-header h2 {
        color: #ffd700;
        margin: 0;
        font-size: 22px;
    }
    .history-list-container {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }
    .history-entry {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .history-entry:hover {
        background: rgba(255,255,255,0.1);
    }
    .history-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .history-date {
        color: rgba(255,255,255,0.6);
        font-size: 12px;
    }
    .history-winner {
        font-size: 12px;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 10px;
    }
    .history-winner.p1 {
        background: rgba(255,107,107,0.3);
        color: #ff6b6b;
    }
    .history-winner.p2 {
        background: rgba(74,158,255,0.3);
        color: #4a9eff;
    }
    .history-winner.tie {
        background: rgba(255,215,0,0.3);
        color: #ffd700;
    }
    .history-scores {
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 18px;
        font-weight: bold;
    }
    .history-scores .p1-score { color: #ff6b6b; }
    .history-scores .p2-score { color: #4a9eff; }
    .history-scores .vs { color: rgba(255,255,255,0.4); font-size: 14px; }
    .history-details {
        font-size: 11px;
        color: rgba(255,255,255,0.5);
        margin-top: 6px;
        text-align: center;
    }
    .no-history {
        color: rgba(255,255,255,0.5);
        text-align: center;
        padding: 40px 20px;
        font-style: italic;
    }
    .overlay-btn {
        position: absolute;
        padding: 12px 24px;
        border: 2px solid;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .overlay-btn:hover {
        transform: scale(1.05);
    }
    .overlay-btn.stats-btn {
        background: rgba(255,215,0,0.3);
        border-color: #ffd700;
        color: #ffd700;
    }
    .overlay-btn.continue-btn {
        background: rgba(0,255,136,0.3);
        border-color: #00ff88;
        color: #00ff88;
    }
    #halftime-stats-btn, #gameover-stats-btn {
        left: 50%;
        transform: translateX(calc(-50% - 85px));
        top: calc(50% + 95px);
    }
    #halftime-continue-btn, #gameover-continue-btn {
        left: 50%;
        transform: translateX(calc(-50% + 85px));
        top: calc(50% + 95px);
    }
    #halftime-stats-btn:hover, #gameover-stats-btn:hover {
        transform: translateX(calc(-50% - 85px)) scale(1.05);
        box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    #halftime-continue-btn:hover, #gameover-continue-btn:hover {
        transform: translateX(calc(-50% + 85px)) scale(1.05);
        box-shadow: 0 0 15px rgba(0,255,136,0.5);
    }
    .history-footer {
        margin-top: 15px;
        flex-shrink: 0;
        display: flex;
        gap: 10px;
    }
    .history-footer .game-btn {
        margin-top: 0;
    }
</style>
</head>
<body>
    <canvas id="game"></canvas>
    <div id="bottom-panel">
        <div id="player1-stats">
            <span class="player-name p1" id="p1-name-display">Player 1:</span><span class="player-score" id="p1-score">0</span>
        </div>
        <div id="center-display">
            <span id="half-display">1st</span>
            <span id="game-timer-display">0:00</span>
            <span id="shot-clock-display"></span>
        </div>
        <div id="player2-stats">
            <span class="player-name p2" id="p2-name-display">Player 2:</span><span class="player-score" id="p2-score">0</span>
        </div>
    </div>
    <button id="settings-btn">‚öôÔ∏è</button>
    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="setting-row">
                <span class="setting-label">Player 1 Name</span>
                <div class="speed-control">
                    <input type="text" id="p1-name-input" maxlength="12" value="Player 1" style="width: 100px; padding: 4px 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #ff6b6b; font-size: 14px;">
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Player 2 Name</span>
                <div class="speed-control">
                    <input type="text" id="p2-name-input" maxlength="12" value="Player 2" style="width: 100px; padding: 4px 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #4a9eff; font-size: 14px;">
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Simulation Speed</span>
                <div class="speed-control">
                    <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1.1">
                    <span id="speed-value">1.1x</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Shot Clock (seconds)</span>
                <div class="speed-control">
                    <input type="range" id="shotclock-slider" min="1" max="24" step="1" value="10">
                    <span id="shotclock-value">3</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Half Length</span>
                <div class="speed-control">
                    <input type="range" id="halftime-slider" min="3" max="900" step="1" value="60">
                    <span id="halftime-value">2:00</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Ball Bounciness</span>
                <div class="speed-control">
                    <input type="range" id="bounce-slider" min="0.1" max="1" step="0.05" value="0.7">
                    <span id="bounce-value">0.7</span>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Game Mode</span>
                <div class="speed-control">
                    <select id="game-mode-select" style="padding: 6px 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 14px; cursor: pointer;">
                        <option value="2player">üë• 2 Player</option>
                    </select>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Debug Mode</span>
                <div class="speed-control">
                    <input type="checkbox" id="debug-checkbox" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
            </div>
            <button class="game-btn" id="reset-game-btn">‚ñ∂Ô∏è Start Game</button>
            <button class="game-btn" id="reset-defaults-btn" style="background: linear-gradient(135deg, #888 0%, #555 100%); color: white;">‚Ü©Ô∏è Reset to Defaults</button>
            <button class="game-btn" id="view-history-btn" style="background: linear-gradient(135deg, #4a9eff 0%, #2a7ed8 100%); color: white;">üìú Game History</button>
            <div class="version-text">Version 3.3.1</div>
        </div>
    </div>

<!-- Stats Modal -->
<div id="stats-modal">
    <div class="stats-content">
        <div class="stats-header">
            <h2>üìä Game Stats</h2>
            <button class="close-btn" id="stats-close-btn">&times;</button>
        </div>
        <div class="stats-summary">
            <div class="player-summary p1">
                <h3 id="stats-p1-name">Player 1</h3>
                <div class="big-score" id="stats-p1-score">0</div>
                <div class="stat-line" id="stats-p1-line">0/0 (0%)</div>
            </div>
            <div class="player-summary p2">
                <h3 id="stats-p2-name">Player 2</h3>
                <div class="big-score" id="stats-p2-score">0</div>
                <div class="stat-line" id="stats-p2-line">0/0 (0%)</div>
            </div>
        </div>
        <div class="shot-log-container">
            <div class="shot-log-title">Shot-by-Shot Log</div>
            <div id="shot-log"></div>
        </div>
        <div class="stats-footer">
            <button class="game-btn" id="play-again-btn">üîÑ Play Again</button>
        </div>
    </div>
</div>

<div id="instructions">Swipe anywhere to shoot! üèÄ</div>

<!-- Halftime Overlay Buttons -->
<div id="halftime-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none;">
    <button id="halftime-stats-btn" class="overlay-btn stats-btn" style="pointer-events: auto;">üìä Stats</button>
    <button id="halftime-continue-btn" class="overlay-btn continue-btn" style="pointer-events: auto;">‚ñ∂ Continue</button>
</div>

<!-- Game Over Overlay Buttons -->
<div id="gameover-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none;">
    <button id="gameover-stats-btn" class="overlay-btn stats-btn" style="pointer-events: auto;">üìä Stats</button>
    <button id="gameover-continue-btn" class="overlay-btn continue-btn" style="pointer-events: auto;">‚û°Ô∏è Continue</button>
</div>

<!-- Game History Modal -->
<div id="history-modal">
    <div class="history-content">
        <div class="history-header">
            <h2>üìú Game History</h2>
            <button class="close-btn" id="history-close-btn">&times;</button>
        </div>
        <div class="history-list-container">
            <div id="history-list"></div>
        </div>
        <div class="history-footer">
            <button class="game-btn" id="history-back-btn">‚Üê Back</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    
    // Hoops (one on each side) - define before resize
    const hoopLeft = {
        x: 0,
        y: 0,
        width: 60,
        rimRadius: 5,
        netHeight: 30,
        side: 'left'
    };
    
    const hoopRight = {
        x: 0,
        y: 0,
        width: 60,
        rimRadius: 5,
        netHeight: 30,
        side: 'right'
    };
    
    // Debug mode
    let debugMode = localStorage.getItem('basketball2p_debug') === 'true';
    
    function debugLog(...args) {
        if (debugMode) {
            console.log('[DEBUG]', ...args);
        }
    }
    
    function debugError(...args) {
        if (debugMode) {
            console.error('[ERROR]', ...args);
        }
    }
    
    function positionHoops() {
        hoopLeft.x = 15;
        hoopLeft.y = height * 0.4;
        hoopRight.x = width - 15;
        hoopRight.y = height * 0.4;
    }
    
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        positionHoops();
    }
    resize();
    window.addEventListener('resize', resize);
    
    // Settings modal
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeBtn = document.querySelector('.close-btn');
    const resetGameBtn = document.getElementById('reset-game-btn');
    const speedSlider = document.getElementById('speed-slider');
    const speedValue = document.getElementById('speed-value');
    
    // Stats modal
    const statsModal = document.getElementById('stats-modal');
    const statsCloseBtn = document.getElementById('stats-close-btn');
    const playAgainBtn = document.getElementById('play-again-btn');
    
    // History modal
    const historyModal = document.getElementById('history-modal');
    const historyCloseBtn = document.getElementById('history-close-btn');
    const historyBackBtn = document.getElementById('history-back-btn');
    const viewHistoryBtn = document.getElementById('view-history-btn');
    const resetDefaultsBtn = document.getElementById('reset-defaults-btn');
    
    // Default settings values
    const DEFAULT_SPEED = 1.1;
    const DEFAULT_SHOT_CLOCK = 10;
    const DEFAULT_HALF_LENGTH = 60;
    const DEFAULT_BOUNCE = 0.7;
    const DEFAULT_P1_NAME = 'Player 1';
    const DEFAULT_P2_NAME = 'Player 2';
    
    // Load saved player names
    const savedP1Name = localStorage.getItem('basketball2p_p1name');
    const savedP2Name = localStorage.getItem('basketball2p_p2name');
    
    let p1Name = savedP1Name !== null ? savedP1Name : DEFAULT_P1_NAME;
    let p2Name = savedP2Name !== null ? savedP2Name : DEFAULT_P2_NAME;
    
    // Game history storage
    let gameHistory = JSON.parse(localStorage.getItem('basketball2p_history') || '[]');
    
    // Settings (pending until new game) - load from localStorage
    const savedSpeed = localStorage.getItem('basketball2p_speed');
    const savedShotClock = localStorage.getItem('basketball2p_shotclock');
    const savedHalfLength = localStorage.getItem('basketball2p_halflength');
    const savedBounce = localStorage.getItem('basketball2p_bounce');
    
    let pendingSpeed = savedSpeed !== null ? parseFloat(savedSpeed) : DEFAULT_SPEED;
    let currentSpeed = pendingSpeed;
    
    let pendingShotClockSeconds = savedShotClock !== null ? parseInt(savedShotClock) : DEFAULT_SHOT_CLOCK;
    
    let pendingHalfLength = savedHalfLength !== null ? parseInt(savedHalfLength) : DEFAULT_HALF_LENGTH;
    let currentHalfLength = pendingHalfLength;
    
    let pendingBounce = savedBounce !== null ? parseFloat(savedBounce) : DEFAULT_BOUNCE;
    let currentBounce = pendingBounce;
    
    // Update slider values from saved settings
    speedSlider.value = pendingSpeed;
    speedValue.textContent = pendingSpeed.toFixed(1) + 'x';
    
    // Player name inputs
    const p1NameInput = document.getElementById('p1-name-input');
    const p2NameInput = document.getElementById('p2-name-input');
    p1NameInput.value = p1Name;
    p2NameInput.value = p2Name;
    
    function updatePlayerNameDisplays() {
        document.getElementById('p1-name-display').textContent = p1Name + ':';
        document.getElementById('p2-name-display').textContent = p2Name + ':';
    }
    updatePlayerNameDisplays();
    
    const shotclockSlider = document.getElementById('shotclock-slider');
    const shotclockValue = document.getElementById('shotclock-value');
    
    shotclockSlider.value = pendingShotClockSeconds;
    shotclockValue.textContent = pendingShotClockSeconds;
    
    const halftimeSlider = document.getElementById('halftime-slider');
    const halftimeValue = document.getElementById('halftime-value');
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }
    
    halftimeSlider.value = pendingHalfLength;
    halftimeValue.textContent = formatTime(pendingHalfLength);
    
    halftimeSlider.addEventListener('input', function(e) {
        pendingHalfLength = parseInt(e.target.value);
        halftimeValue.textContent = formatTime(pendingHalfLength);
    });
    
    const bounceSlider = document.getElementById('bounce-slider');
    const bounceValue = document.getElementById('bounce-value');
    
    bounceSlider.value = pendingBounce;
    bounceValue.textContent = pendingBounce.toFixed(2);
    
    bounceSlider.addEventListener('input', function(e) {
        pendingBounce = parseFloat(e.target.value);
        bounceValue.textContent = pendingBounce.toFixed(2);
    });
    
    shotclockSlider.addEventListener('input', function(e) {
        pendingShotClockSeconds = parseInt(e.target.value);
        shotclockValue.textContent = pendingShotClockSeconds;
    });
    
    speedSlider.addEventListener('input', function(e) {
        pendingSpeed = parseFloat(e.target.value);
        speedValue.textContent = pendingSpeed.toFixed(1) + 'x';
    });
    
    // Debug mode checkbox
    const debugCheckbox = document.getElementById('debug-checkbox');
    debugCheckbox.checked = debugMode;
    
    debugCheckbox.addEventListener('change', function(e) {
        debugMode = e.target.checked;
        localStorage.setItem('basketball2p_debug', debugMode);
        if (debugMode) {
            console.log('[DEBUG] Debug mode enabled');
        }
    });
    
    settingsBtn.addEventListener('click', function() {
        isPaused = true;
        settingsModal.classList.add('open');
    });
    
    closeBtn.addEventListener('click', function() {
        isPaused = false;
        lastClockUpdate = Date.now();
        lastGameTimerUpdate = Date.now();
        settingsModal.classList.remove('open');
    });
    
    settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
            isPaused = false;
            lastClockUpdate = Date.now();
            lastGameTimerUpdate = Date.now();
            settingsModal.classList.remove('open');
        }
    });
    
    resetGameBtn.addEventListener('click', function() {
        currentSpeed = pendingSpeed;
        currentShotClockSeconds = pendingShotClockSeconds;
        currentHalfLength = pendingHalfLength;
        currentBounce = pendingBounce;
        
        p1Name = p1NameInput.value.trim() || DEFAULT_P1_NAME;
        p2Name = p2NameInput.value.trim() || DEFAULT_P2_NAME;
        localStorage.setItem('basketball2p_p1name', p1Name);
        localStorage.setItem('basketball2p_p2name', p2Name);
        updatePlayerNameDisplays();
        
        localStorage.setItem('basketball2p_speed', pendingSpeed);
        localStorage.setItem('basketball2p_shotclock', pendingShotClockSeconds);
        localStorage.setItem('basketball2p_halflength', pendingHalfLength);
        localStorage.setItem('basketball2p_bounce', pendingBounce);
        
        if (!gameStarted) {
            gameStarted = true;
        }
        
        isPaused = false;
        resetGame();
        settingsModal.classList.remove('open');
    });
    
    statsCloseBtn.addEventListener('click', function() {
        statsModal.classList.remove('open');
    });
    
    playAgainBtn.addEventListener('click', function() {
        statsModal.classList.remove('open');
        resetGameBtn.click();
    });
    
    statsModal.addEventListener('click', function(e) {
        if (e.target === statsModal) {
            statsModal.classList.remove('open');
        }
    });
    
    viewHistoryBtn.addEventListener('click', function() {
        settingsModal.classList.remove('open');
        showHistoryModal();
    });
    
    resetDefaultsBtn.addEventListener('click', function() {
        pendingSpeed = DEFAULT_SPEED;
        pendingShotClockSeconds = DEFAULT_SHOT_CLOCK;
        pendingHalfLength = DEFAULT_HALF_LENGTH;
        pendingBounce = DEFAULT_BOUNCE;
        
        speedSlider.value = DEFAULT_SPEED;
        speedValue.textContent = DEFAULT_SPEED.toFixed(1) + 'x';
        
        shotclockSlider.value = DEFAULT_SHOT_CLOCK;
        shotclockValue.textContent = DEFAULT_SHOT_CLOCK;
        
        halftimeSlider.value = DEFAULT_HALF_LENGTH;
        halftimeValue.textContent = formatTime(DEFAULT_HALF_LENGTH);
        
        bounceSlider.value = DEFAULT_BOUNCE;
        bounceValue.textContent = DEFAULT_BOUNCE.toFixed(2);
        
        localStorage.removeItem('basketball2p_speed');
        localStorage.removeItem('basketball2p_shotclock');
        localStorage.removeItem('basketball2p_halflength');
        localStorage.removeItem('basketball2p_bounce');
    });
    
    historyCloseBtn.addEventListener('click', function() {
        historyModal.classList.remove('open');
    });
    
    historyBackBtn.addEventListener('click', function() {
        historyModal.classList.remove('open');
        settingsModal.classList.add('open');
    });
    
    historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
            historyModal.classList.remove('open');
        }
    });
    
    // Halftime and Game Over overlay buttons
    var halftimeOverlay = document.getElementById('halftime-overlay');
    var gameoverOverlay = document.getElementById('gameover-overlay');
    var halftimeStatsBtn = document.getElementById('halftime-stats-btn');
    var halftimeContinueBtn = document.getElementById('halftime-continue-btn');
    var gameoverStatsBtn = document.getElementById('gameover-stats-btn');
    var gameoverContinueBtn = document.getElementById('gameover-continue-btn');
    
    halftimeStatsBtn.addEventListener('click', function() {
        debugLog('Halftime stats button clicked');
        showStatsModal(true);
    });
    
    halftimeContinueBtn.addEventListener('click', function() {
        debugLog('Halftime continue button clicked');
        startSecondHalf();
    });
    
    gameoverStatsBtn.addEventListener('click', function() {
        debugLog('Game over stats button clicked');
        showStatsModal(false);
    });
    
    gameoverContinueBtn.addEventListener('click', function() {
        debugLog('Game over continue button clicked');
        settingsModal.classList.add('open');
    });
    
    function updateOverlays() {
        halftimeOverlay.style.display = isHalftime ? 'block' : 'none';
        gameoverOverlay.style.display = isGameOver ? 'block' : 'none';
    }
    
    // Player stats
    var players = {
        1: { score: 0, shots: 0, turnovers: 0, color: '#ff6b6b' },
        2: { score: 0, shots: 0, turnovers: 0, color: '#4a9eff' }
    };
    
    // Detailed shot tracking
    var shotHistory = [];
    var currentShotData = null;
    
    var currentPlayer = 1;
    var waitingForNextTurn = false;
    var initialDrop = true;
    
    // Shot clock
    var currentShotClockSeconds = pendingShotClockSeconds;
    var shotClock = currentShotClockSeconds;
    var lastClockUpdate = Date.now();
    var shotClockActive = false;
    
    // Game timer and halves
    var gameTimer = currentHalfLength;
    var lastGameTimerUpdate = Date.now();
    var currentHalf = 1;
    var isHalftime = false;
    var isGameOver = false;
    var sidesSwapped = false;
    
    // Physics constants
    var GRAVITY = 0.55;
    var BOUNCE_DAMPING = 0.7;
    var AIR_RESISTANCE = 0.997;
    var FRICTION = 0.98;
    
    // Ball
    var ball = {
        x: 0,
        y: 0,
        vx: 0,
        vy: 0,
        radius: 18,
        rotation: 0,
        angularVel: 0,
        grounded: false
    };
    
    // Swipe tracking
    var isDragging = false;
    var dragStart = { x: 0, y: 0, time: 0 };
    var dragPoints = [];
    
    // Particles for effects
    var particles = [];
    
    // Score animation
    var scorePopups = [];
    var turnAnimationStart = 0;
    
    // Turnover animation
    var showingTurnover = false;
    var turnoverStartTime = 0;
    
    // Game pause state
    var isPaused = false;
    
    function showTurnIndicator() {
        var p1Stats = document.getElementById('player1-stats');
        var p2Stats = document.getElementById('player2-stats');
        
        if (currentPlayer === 1) {
            p1Stats.classList.add('active');
            p2Stats.classList.remove('active');
            p1Stats.classList.remove('pulse');
            void p1Stats.offsetWidth;
            p1Stats.classList.add('pulse');
        } else {
            p1Stats.classList.remove('active');
            p2Stats.classList.add('active');
            p2Stats.classList.remove('pulse');
            void p2Stats.offsetWidth;
            p2Stats.classList.add('pulse');
        }
    }
    
    function updateStats() {
        document.getElementById('p1-score').textContent = players[1].score;
        document.getElementById('p2-score').textContent = players[2].score;
    }
    
    function updateTopPanel() {
        document.getElementById('game-timer-display').textContent = formatTime(gameTimer);
        document.getElementById('half-display').textContent = currentHalf === 1 ? '1st' : '2nd';
        
        var shotClockEl = document.getElementById('shot-clock-display');
        if (shotClockActive && ball.grounded && !waitingForNextTurn) {
            shotClockEl.textContent = shotClock < 10 ? '0' + shotClock : shotClock;
            if (shotClock <= 3) {
                shotClockEl.classList.add('warning');
            } else {
                shotClockEl.classList.remove('warning');
            }
        } else {
            shotClockEl.textContent = '';
            shotClockEl.classList.remove('warning');
        }
    }
    
    function resetBall() {
        ball.x = width / 2;
        ball.y = -ball.radius;
        ball.vx = 0;
        ball.vy = 0;
        ball.angularVel = 0;
        ball.grounded = false;
    }
    
    function dropBall() {
        ball.x = width / 2;
        ball.y = height * 0.25;
        ball.vx = 0;
        ball.vy = 5 * currentSpeed;
        ball.angularVel = 0;
        ball.grounded = false;
    }
    
    function resetGame() {
        positionHoops();
        players[1].score = 0;
        players[1].shots = 0;
        players[1].turnovers = 0;
        players[2].score = 0;
        players[2].shots = 0;
        players[2].turnovers = 0;
        currentPlayer = 1;
        waitingForNextTurn = false;
        initialDrop = true;
        shotClock = currentShotClockSeconds;
        lastClockUpdate = Date.now();
        shotClockActive = false;
        gameTimer = currentHalfLength;
        lastGameTimerUpdate = Date.now();
        currentHalf = 1;
        isHalftime = false;
        isGameOver = false;
        sidesSwapped = false;
        shotHistory = [];
        currentShotData = null;
        updateStats();
        dropBall();
        showTurnIndicator();
    }
    
    function startSecondHalf() {
        currentHalf = 2;
        isHalftime = false;
        sidesSwapped = true;
        gameTimer = currentHalfLength;
        lastGameTimerUpdate = Date.now();
        currentPlayer = 2;
        waitingForNextTurn = false;
        initialDrop = true;
        shotClock = currentShotClockSeconds;
        lastClockUpdate = Date.now();
        shotClockActive = false;
        dropBall();
        showTurnIndicator();
    }
    
    function getTargetHoop(player) {
        if (sidesSwapped) {
            return player === 1 ? 'left' : 'right';
        } else {
            return player === 1 ? 'right' : 'left';
        }
    }
    
    function init() {
        positionHoops();
        dropBall();
        showTurnIndicator();
    }
    
    // Input handlers
    function getPos(e) {
        var rect = canvas.getBoundingClientRect();
        var clientX, clientY;
        
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else if (e.changedTouches && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        return { 
            x: clientX - rect.left, 
            y: clientY - rect.top 
        };
    }
    
    function onStart(e) {
        e.preventDefault();
        if (!gameStarted) return;
        if (isHalftime || isGameOver) return;
        if (waitingForNextTurn) return;
        if (showingTurnover) return;
        
        var pos = getPos(e);
        
        if (ball.grounded) {
            isDragging = true;
            dragStart = { x: pos.x, y: pos.y, time: Date.now() };
            dragPoints = [{ x: pos.x, y: pos.y, time: Date.now() }];
        }
    }
    
    function onMove(e) {
        e.preventDefault();
        if (!isDragging) return;
        
        var pos = getPos(e);
        dragPoints.push({ x: pos.x, y: pos.y, time: Date.now() });
        if (dragPoints.length > 10) dragPoints.shift();
    }
    
    function onEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        
        if (dragPoints.length >= 2) {
            var lastPoint = dragPoints[dragPoints.length - 1];
            var dx = lastPoint.x - dragStart.x;
            var dy = lastPoint.y - dragStart.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist > 10) {
                var dirX = dx / dist;
                var dirY = dy / dist;
                
                var power = Math.min(dist / 200, 1);
                var maxSpeed = 55;
                var speed = power * maxSpeed;
                
                shotOriginX = ball.x;
                wentThroughFromBelow = false;
                
                var angle = Math.atan2(dy, dx) * (180 / Math.PI);
                
                currentShotData = {
                    player: currentPlayer,
                    half: currentHalf,
                    gameTime: gameTimer,
                    shotClock: shotClock,
                    startX: Math.round(ball.x),
                    startY: Math.round(ball.y),
                    angle: Math.round(angle),
                    power: Math.round(power * 100),
                    bounces: [],
                    scored: false,
                    points: 0,
                    endX: 0,
                    endY: 0
                };
                
                ball.vx = dirX * speed;
                ball.vy = dirY * speed;
                
                ball.angularVel = ball.vx * 0.05;
                ball.grounded = false;
                shotClockActive = false;
                
                players[currentPlayer].shots++;
                updateStats();
                
                for (var i = 0; i < 5; i++) {
                    particles.push({
                        x: ball.x,
                        y: ball.y,
                        vx: -ball.vx * 0.2 + (Math.random() - 0.5) * 2,
                        vy: -ball.vy * 0.2 + (Math.random() - 0.5) * 2,
                        life: 1,
                        decay: 0.03,
                        size: Math.random() * 8 + 4,
                        color: players[currentPlayer].color
                    });
                }
            }
        }
        
        dragPoints = [];
    }
    
    canvas.addEventListener('mousedown', onStart);
    canvas.addEventListener('mousemove', onMove);
    canvas.addEventListener('mouseup', onEnd);
    canvas.addEventListener('mouseleave', onEnd);
    canvas.addEventListener('touchstart', onStart);
    canvas.addEventListener('touchmove', onMove);
    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        if (isHalftime || isGameOver || !gameStarted) {
            handleCanvasClick(e);
            return;
        }
        if (isDragging) {
            onEnd(e);
        } else {
            handleCanvasClick(e);
        }
    });
    
    // Collision detection
    var lastBallY = 0;
    var scoredThisShot = false;
    var shotOriginX = 0;
    var wentThroughFromBelow = false;
    
    function isThreePointer(shotX, targetHoop) {
        var threePointRadius = width / 3;
        if (targetHoop === 'left') {
            var arcCenterX = hoopLeft.x + hoopLeft.width / 2;
            return shotX > arcCenterX + threePointRadius;
        } else {
            var arcCenterX = hoopRight.x - hoopRight.width / 2;
            return shotX < arcCenterX - threePointRadius;
        }
    }
    
    function checkHoopCollision(hoop) {
        var rimLeftX = hoop.side === 'left' ? hoop.x : hoop.x - hoop.width;
        var rimRightX = hoop.side === 'left' ? hoop.x + hoop.width : hoop.x;
        
        var rimLeft = { x: rimLeftX, y: hoop.y };
        var rimRight = { x: rimRightX, y: hoop.y };
        
        var rims = [rimLeft, rimRight];
        for (var r = 0; r < rims.length; r++) {
            var rim = rims[r];
            var dx = ball.x - rim.x;
            var dy = ball.y - rim.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            var minDist = ball.radius + hoop.rimRadius;
            
            if (dist < minDist && dist > 0) {
                var nx = dx / dist;
                var ny = dy / dist;
                
                var overlap = minDist - dist;
                ball.x += nx * overlap;
                ball.y += ny * overlap;
                
                var dot = ball.vx * nx + ball.vy * ny;
                ball.vx = (ball.vx - 2 * dot * nx) * currentBounce;
                ball.vy = (ball.vy - 2 * dot * ny) * currentBounce;
                
                ball.angularVel = ball.vx * 0.03;
                
                for (var i = 0; i < 3; i++) {
                    particles.push({
                        x: rim.x,
                        y: rim.y,
                        vx: (Math.random() - 0.5) * 5,
                        vy: (Math.random() - 0.5) * 5,
                        life: 1,
                        decay: 0.05,
                        size: Math.random() * 6 + 2,
                        color: '#ff4444'
                    });
                }
            }
        }
        
        if (!scoredThisShot) {
            var inHoopX = ball.x > rimLeftX && ball.x < rimRightX;
            var crossedHoopDown = lastBallY <= hoop.y && ball.y > hoop.y;
            var crossedHoopUp = lastBallY >= hoop.y && ball.y < hoop.y;
            var goingDown = ball.vy > 0;
            var goingUp = ball.vy < 0;
            
            var correctHoop = hoop.side === getTargetHoop(currentPlayer);
            
            if (inHoopX && crossedHoopUp && goingUp && correctHoop) {
                wentThroughFromBelow = true;
            }
            
            if (inHoopX && crossedHoopDown && goingDown && correctHoop) {
                var points;
                if (wentThroughFromBelow) {
                    points = 1;
                } else {
                    points = isThreePointer(shotOriginX, hoop.side) ? 3 : 2;
                }
                players[currentPlayer].score += points;
                scoredThisShot = true;
                
                if (currentShotData) {
                    currentShotData.scored = true;
                    currentShotData.points = points;
                }
                
                updateStats();
                
                scorePopups.push({
                    x: hoop.side === 'left' ? hoop.x + hoop.width / 2 : hoop.x - hoop.width / 2,
                    y: hoop.y + 60,
                    text: '+' + points,
                    life: 1,
                    scale: 0.5,
                    color: players[currentPlayer].color
                });
                
                for (var i = 0; i < 20; i++) {
                    var angle = Math.random() * Math.PI * 2;
                    var speed = Math.random() * 8 + 2;
                    var colors = ['#ffd700', players[currentPlayer].color, '#00ff88'];
                    particles.push({
                        x: ball.x,
                        y: ball.y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 1,
                        decay: 0.02,
                        size: Math.random() * 10 + 5,
                        color: colors[Math.floor(Math.random() * 3)]
                    });
                }
            }
        }
    }
    
    function switchTurn() {
        if (isHalftime || isGameOver) return;
        
        if (isDragging) {
            isDragging = false;
            dragPoints = [];
        }
        
        currentPlayer = currentPlayer === 1 ? 2 : 1;
        scoredThisShot = false;
        waitingForNextTurn = false;
        shotClock = currentShotClockSeconds;
        lastClockUpdate = Date.now();
        shotClockActive = true;
        showTurnIndicator();
    }
    
    function update() {
        if (isPaused) return;
        
        if (!ball.grounded) {
            var prevBallY = ball.y;
            
            ball.vy += GRAVITY * currentSpeed;
            ball.vx *= Math.pow(AIR_RESISTANCE, currentSpeed);
            ball.vy *= Math.pow(AIR_RESISTANCE, currentSpeed);
            
            ball.x += ball.vx * currentSpeed;
            ball.y += ball.vy * currentSpeed;
            
            ball.rotation += ball.angularVel * currentSpeed;
            ball.angularVel *= 0.99;
            
            lastBallY = prevBallY;
            
            checkHoopCollision(hoopLeft);
            checkHoopCollision(hoopRight);
            
            if (ball.y + ball.radius > height - 90) {
                ball.y = height - 90 - ball.radius;
                ball.vy *= -currentBounce;
                ball.vx *= FRICTION;
                ball.angularVel = ball.vx * 0.03;
                
                if (currentShotData && Math.abs(ball.vy) > 1) {
                    currentShotData.bounces.push({
                        x: Math.round(ball.x),
                        y: Math.round(ball.y)
                    });
                }
                
                if (Math.abs(ball.vy) < 1 && Math.abs(ball.vx) < 0.5) {
                    ball.grounded = true;
                    ball.vx = 0;
                    ball.vy = 0;
                    
                    if (currentShotData) {
                        currentShotData.endX = Math.round(ball.x);
                        currentShotData.endY = Math.round(ball.y);
                        shotHistory.push(currentShotData);
                        currentShotData = null;
                    }
                    
                    if (initialDrop) {
                        initialDrop = false;
                        shotClockActive = true;
                        lastClockUpdate = Date.now();
                        lastGameTimerUpdate = Date.now();
                    } else if (!waitingForNextTurn) {
                        waitingForNextTurn = true;
                        setTimeout(switchTurn, 800);
                    }
                }
            }
            
            if (ball.x - ball.radius < 0) {
                ball.x = ball.radius;
                ball.vx *= -currentBounce;
                if (currentShotData) {
                    currentShotData.bounces.push({
                        x: Math.round(ball.x),
                        y: Math.round(ball.y),
                        wall: 'left'
                    });
                }
            }
            if (ball.x + ball.radius > width) {
                ball.x = width - ball.radius;
                ball.vx *= -currentBounce;
                if (currentShotData) {
                    currentShotData.bounces.push({
                        x: Math.round(ball.x),
                        y: Math.round(ball.y),
                        wall: 'right'
                    });
                }
            }
        }
        
        var newParticles = [];
        for (var i = 0; i < particles.length; i++) {
            var p = particles[i];
            p.x += p.vx * currentSpeed;
            p.y += p.vy * currentSpeed;
            p.vy += 0.1 * currentSpeed;
            p.life -= p.decay * currentSpeed;
            if (p.life > 0) newParticles.push(p);
        }
        particles = newParticles;
        
        var newPopups = [];
        for (var i = 0; i < scorePopups.length; i++) {
            var s = scorePopups[i];
            s.scale += 0.015 * currentSpeed;
            s.life -= 0.004 * currentSpeed;
            if (s.life > 0) newPopups.push(s);
        }
        scorePopups = newPopups;
        
        if (shotClockActive && ball.grounded && !isHalftime && !isGameOver) {
            var now = Date.now();
            var elapsed = (now - lastClockUpdate) / 1000;
            if (elapsed >= 1) {
                shotClock -= Math.floor(elapsed);
                lastClockUpdate = now;
                
                if (shotClock <= 0) {
                    shotClock = 0;
                    shotClockActive = false;
                    
                    if (isDragging) {
                        isDragging = false;
                        dragPoints = [];
                    }
                    
                    players[currentPlayer].turnovers++;
                    
                    showingTurnover = true;
                    turnoverStartTime = Date.now();
                    waitingForNextTurn = true;
                    
                    setTimeout(function() {
                        showingTurnover = false;
                        switchTurn();
                    }, 1000);
                }
            }
        }
        
        if (gameStarted && !isHalftime && !isGameOver && !initialDrop) {
            var now = Date.now();
            var elapsed = (now - lastGameTimerUpdate) / 1000;
            if (elapsed >= 1) {
                gameTimer -= Math.floor(elapsed);
                lastGameTimerUpdate = now;
                
                if (gameTimer <= 0) {
                    gameTimer = 0;
                }
            }
            
            if (gameTimer <= 0 && ball.grounded) {
                if (currentHalf === 1) {
                    debugLog('Entering halftime');
                    isHalftime = true;
                    shotClockActive = false;
                    isDragging = false;
                    dragPoints = [];
                } else {
                    debugLog('Game over');
                    isGameOver = true;
                    shotClockActive = false;
                    isDragging = false;
                    dragPoints = [];
                    saveGameToHistory();
                }
            }
        }
    }
    
    function showStatsModal(isHalftimeMode) {
        debugLog('showStatsModal called, isHalftimeMode:', isHalftimeMode);
        
        document.getElementById('stats-p1-name').textContent = p1Name;
        document.getElementById('stats-p2-name').textContent = p2Name;
        
        document.getElementById('stats-p1-score').textContent = players[1].score;
        document.getElementById('stats-p2-score').textContent = players[2].score;
        
        var p1Made = 0;
        for (var i = 0; i < shotHistory.length; i++) {
            if (shotHistory[i].player === 1 && shotHistory[i].scored) p1Made++;
        }
        var p1Total = players[1].shots;
        var p1Pct = p1Total > 0 ? Math.round((p1Made / p1Total) * 100) : 0;
        document.getElementById('stats-p1-line').textContent = p1Made + '/' + p1Total + ' (' + p1Pct + '%) ‚Ä¢ turnovers: ' + players[1].turnovers;
        
        var p2Made = 0;
        for (var i = 0; i < shotHistory.length; i++) {
            if (shotHistory[i].player === 2 && shotHistory[i].scored) p2Made++;
        }
        var p2Total = players[2].shots;
        var p2Pct = p2Total > 0 ? Math.round((p2Made / p2Total) * 100) : 0;
        document.getElementById('stats-p2-line').textContent = p2Made + '/' + p2Total + ' (' + p2Pct + '%) ‚Ä¢ turnovers: ' + players[2].turnovers;
        
        if (isHalftimeMode) {
            playAgainBtn.style.display = 'none';
        } else {
            playAgainBtn.style.display = 'block';
        }
        
        var shotLog = document.getElementById('shot-log');
        shotLog.innerHTML = '';
        
        if (shotHistory.length === 0) {
            shotLog.innerHTML = '<div class="no-shots">No shots taken</div>';
        } else {
            for (var index = 0; index < shotHistory.length; index++) {
                var shot = shotHistory[index];
                var entry = document.createElement('div');
                entry.className = 'shot-entry p' + shot.player + (shot.scored ? ' scored' : '');
                
                var pointsText = shot.scored 
                    ? (shot.points === 3 ? '3PT' : shot.points === 2 ? '2PT' : '1PT') 
                    : 'MISS';
                
                var halfText = shot.half === 1 ? '1st' : '2nd';
                var bounceCount = shot.bounces.length;
                var wallBounces = 0;
                for (var b = 0; b < shot.bounces.length; b++) {
                    if (shot.bounces[b].wall) wallBounces++;
                }
                var playerName = shot.player === 1 ? p1Name : p2Name;
                
                entry.innerHTML = '<div class="shot-header"><span class="shot-player">' + playerName + ' - Shot #' + (index + 1) + '</span><span class="shot-result ' + (shot.scored ? 'made' : 'missed') + '">' + pointsText + '</span></div><div class="shot-details"><span>‚è±Ô∏è ' + halfText + ' ' + formatTime(shot.gameTime) + '</span><span>üí™ ' + shot.power + '% power</span><span>üìê ' + shot.angle + '¬∞ angle</span><span>üèÄ ' + bounceCount + ' bounce' + (bounceCount !== 1 ? 's' : '') + (wallBounces > 0 ? ' (' + wallBounces + ' wall)' : '') + '</span><span>üöÄ From: (' + shot.startX + ', ' + shot.startY + ')</span><span>üéØ To: (' + shot.endX + ', ' + shot.endY + ')</span></div>';
                
                shotLog.appendChild(entry);
            }
        }
        
        statsModal.classList.add('open');
    }
    
    function saveGameToHistory() {
        var gameData = {
            id: Date.now(),
            date: new Date().toISOString(),
            playerNames: {
                1: p1Name,
                2: p2Name
            },
            players: {
                1: { score: players[1].score, shots: players[1].shots, turnovers: players[1].turnovers },
                2: { score: players[2].score, shots: players[2].shots, turnovers: players[2].turnovers }
            },
            settings: {
                speed: currentSpeed,
                shotClock: currentShotClockSeconds,
                halfLength: currentHalfLength,
                bounce: currentBounce
            },
            shotHistory: shotHistory
        };
        
        gameHistory.unshift(gameData);
        
        if (gameHistory.length > 50) {
            gameHistory = gameHistory.slice(0, 50);
        }
        
        localStorage.setItem('basketball2p_history', JSON.stringify(gameHistory));
    }
    
    function showHistoryModal(selectedGameId) {
        var historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        
        if (gameHistory.length === 0) {
            historyList.innerHTML = '<div class="no-history">No games played yet.<br>Complete a game to see it here!</div>';
        } else if (selectedGameId) {
            var game = null;
            for (var i = 0; i < gameHistory.length; i++) {
                if (gameHistory[i].id === selectedGameId) {
                    game = gameHistory[i];
                    break;
                }
            }
            if (!game) return;
            
            var gameP1Name = game.playerNames ? game.playerNames[1] : 'Player 1';
            var gameP2Name = game.playerNames ? game.playerNames[2] : 'Player 2';
            
            var p1Made = 0, p2Made = 0;
            for (var i = 0; i < game.shotHistory.length; i++) {
                if (game.shotHistory[i].player === 1 && game.shotHistory[i].scored) p1Made++;
                if (game.shotHistory[i].player === 2 && game.shotHistory[i].scored) p2Made++;
            }
            var p1Pct = game.players[1].shots > 0 ? Math.round((p1Made / game.players[1].shots) * 100) : 0;
            var p2Pct = game.players[2].shots > 0 ? Math.round((p2Made / game.players[2].shots) * 100) : 0;
            var p1TO = game.players[1].turnovers || 0;
            var p2TO = game.players[2].turnovers || 0;
            
            var html = '<div style="margin-bottom: 15px;"><button class="game-btn" id="back-to-list-btn" style="padding: 8px 16px; font-size: 14px;">‚Üê Back to List</button></div><div class="stats-summary" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;"><div class="player-summary p1"><h3>' + gameP1Name + '</h3><div class="big-score">' + game.players[1].score + '</div><div class="stat-line">' + p1Made + '/' + game.players[1].shots + ' (' + p1Pct + '%) ‚Ä¢ turnovers: ' + p1TO + '</div></div><div class="player-summary p2"><h3>' + gameP2Name + '</h3><div class="big-score">' + game.players[2].score + '</div><div class="stat-line">' + p2Made + '/' + game.players[2].shots + ' (' + p2Pct + '%) ‚Ä¢ turnovers: ' + p2TO + '</div></div></div><div class="shot-log-title">Shot-by-Shot Log</div>';
            
            if (game.shotHistory.length === 0) {
                html += '<div class="no-shots">No shots taken</div>';
            } else {
                for (var index = 0; index < game.shotHistory.length; index++) {
                    var shot = game.shotHistory[index];
                    var pointsText = shot.scored ? (shot.points === 3 ? '3PT' : shot.points === 2 ? '2PT' : '1PT') : 'MISS';
                    var halfText = shot.half === 1 ? '1st' : '2nd';
                    var bounceCount = shot.bounces.length;
                    var wallBounces = 0;
                    for (var b = 0; b < shot.bounces.length; b++) {
                        if (shot.bounces[b].wall) wallBounces++;
                    }
                    var shotPlayerName = shot.player === 1 ? gameP1Name : gameP2Name;
                    
                    html += '<div class="shot-entry p' + shot.player + (shot.scored ? ' scored' : '') + '"><div class="shot-header"><span class="shot-player">' + shotPlayerName + ' - Shot #' + (index + 1) + '</span><span class="shot-result ' + (shot.scored ? 'made' : 'missed') + '">' + pointsText + '</span></div><div class="shot-details"><span>‚è±Ô∏è ' + halfText + ' ' + formatTime(shot.gameTime) + '</span><span>üí™ ' + shot.power + '% power</span><span>üìê ' + shot.angle + '¬∞ angle</span><span>üèÄ ' + bounceCount + ' bounce' + (bounceCount !== 1 ? 's' : '') + (wallBounces > 0 ? ' (' + wallBounces + ' wall)' : '') + '</span><span>üöÄ From: (' + shot.startX + ', ' + shot.startY + ')</span><span>üéØ To: (' + shot.endX + ', ' + shot.endY + ')</span></div></div>';
                }
            }
            
            historyList.innerHTML = html;
            
            document.getElementById('back-to-list-btn').addEventListener('click', function() {
                showHistoryModal();
            });
        } else {
            for (var g = 0; g < gameHistory.length; g++) {
                var game = gameHistory[g];
                var date = new Date(game.date);
                var dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                var gameP1Name = game.playerNames ? game.playerNames[1] : 'Player 1';
                var gameP2Name = game.playerNames ? game.playerNames[2] : 'Player 2';
                
                var winnerClass, winnerText;
                if (game.players[1].score > game.players[2].score) {
                    winnerClass = 'p1';
                    winnerText = gameP1Name + ' Won';
                } else if (game.players[2].score > game.players[1].score) {
                    winnerClass = 'p2';
                    winnerText = gameP2Name + ' Won';
                } else {
                    winnerClass = 'tie';
                    winnerText = 'Tie';
                }
                
                var totalShots = game.players[1].shots + game.players[2].shots;
                
                var entry = document.createElement('div');
                entry.className = 'history-entry';
                entry.innerHTML = '<div class="history-entry-header"><span class="history-date">' + dateStr + '</span><span class="history-winner ' + winnerClass + '">' + winnerText + '</span></div><div class="history-scores"><span class="p1-score">' + game.players[1].score + '</span><span class="vs">vs</span><span class="p2-score">' + game.players[2].score + '</span></div><div class="history-details">' + totalShots + ' total shots ‚Ä¢ ' + formatTime(game.settings.halfLength) + ' halves</div>';
                
                (function(gameId) {
                    entry.addEventListener('click', function() {
                        showHistoryModal(gameId);
                    });
                })(game.id);
                
                historyList.appendChild(entry);
            }
        }
        
        historyModal.classList.add('open');
    }
    
    function drawCourt() {
        ctx.fillStyle = '#8B4513';
        ctx.fillRect(0, height - 90, width, 40);
        
        ctx.strokeStyle = '#a0522d';
        ctx.lineWidth = 2;
        for (var x = 0; x < width; x += 80) {
            ctx.beginPath();
            ctx.moveTo(x, height - 90);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
        
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 10]);
        ctx.beginPath();
        ctx.moveTo(width / 2, 0);
        ctx.lineTo(width / 2, height - 90);
        ctx.stroke();
        ctx.setLineDash([]);
        
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.lineWidth = 3;
        var threePointRadius = width / 3;
        ctx.beginPath();
        ctx.arc(hoopLeft.x + hoopLeft.width / 2, height - 90, threePointRadius, Math.PI, 0);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(hoopRight.x - hoopRight.width / 2, height - 90, threePointRadius, Math.PI, 0);
        ctx.stroke();
    }
    
    function drawShotClock() {}
    function drawGameTimer() {}
    
    function drawHalftimeScreen() {
        if (!isHalftime) return;
        
        ctx.fillStyle = 'rgba(0,0,0,0.85)';
        ctx.fillRect(0, 0, width, height);
        
        ctx.fillStyle = '#ffd700';
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('HALFTIME', width / 2, height / 2 - 120);
        
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.fillRect(width / 2 - 150, height / 2 - 80, 300, 120);
        
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = players[1].color;
        ctx.textAlign = 'left';
        ctx.fillText(p1Name, width / 2 - 130, height / 2 - 50);
        ctx.fillStyle = '#ffd700';
        ctx.textAlign = 'right';
        ctx.fillText(players[1].score, width / 2 + 130, height / 2 - 50);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '14px Arial';
        ctx.fillText(players[1].shots + ' shots', width / 2 + 130, height / 2 - 30);
        
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = players[2].color;
        ctx.textAlign = 'left';
        ctx.fillText(p2Name, width / 2 - 130, height / 2);
        ctx.fillStyle = '#ffd700';
        ctx.textAlign = 'right';
        ctx.fillText(players[2].score, width / 2 + 130, height / 2);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '14px Arial';
        ctx.fillText(players[2].shots + ' shots', width / 2 + 130, height / 2 + 20);
        
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sides will swap for 2nd half', width / 2, height / 2 + 65);
    }
    
    function drawGameOverScreen() {
        if (!isGameOver) return;
        
        ctx.fillStyle = 'rgba(0,0,0,0.9)';
        ctx.fillRect(0, 0, width, height);
        
        ctx.fillStyle = '#ffd700';
        ctx.font = 'bold 42px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('GAME OVER', width / 2, 60);
        
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.fillRect(width / 2 - 150, 95, 300, 100);
        
        ctx.font = 'bold 22px Arial';
        ctx.fillStyle = players[1].color;
        ctx.textAlign = 'left';
        ctx.fillText(p1Name, width / 2 - 130, 125);
        ctx.fillStyle = '#ffd700';
        ctx.textAlign = 'right';
        ctx.fillText(players[1].score, width / 2 + 130, 125);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '12px Arial';
        ctx.fillText(players[1].shots + ' shots', width / 2 + 130, 142);
        
        ctx.font = 'bold 22px Arial';
        ctx.fillStyle = players[2].color;
        ctx.textAlign = 'left';
        ctx.fillText(p2Name, width / 2 - 130, 168);
        ctx.fillStyle = '#ffd700';
        ctx.textAlign = 'right';
        ctx.fillText(players[2].score, width / 2 + 130, 168);
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.font = '12px Arial';
        ctx.fillText(players[2].shots + ' shots', width / 2 + 130, 185);
        
        ctx.font = 'bold 26px Arial';
        ctx.textAlign = 'center';
        var winnerText;
        if (players[1].score > players[2].score) {
            ctx.fillStyle = players[1].color;
            winnerText = 'üèÜ ' + p1Name + ' Wins! üèÜ';
        } else if (players[2].score > players[1].score) {
            ctx.fillStyle = players[2].color;
            winnerText = 'üèÜ ' + p2Name + ' Wins! üèÜ';
        } else {
            ctx.fillStyle = '#ffd700';
            winnerText = "It's a Tie!";
        }
        ctx.fillText(winnerText, width / 2, 230);
        
        ctx.fillStyle = 'rgba(255,255,255,0.7)';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        var settingsY = 270;
        var settingsText = currentSpeed.toFixed(1) + 'x speed  ‚Ä¢  ' + currentShotClockSeconds + 's shot clock  ‚Ä¢  ' + formatTime(currentHalfLength) + ' halves  ‚Ä¢  ' + currentBounce.toFixed(2) + ' bounce';
        ctx.fillText(settingsText, width / 2, settingsY);
    }
    
    function drawBackboard(hoop) {
        var isLeft = hoop.side === 'left';
        var boardX = isLeft ? 0 : width - 10;
        var hoopColor;
        if (sidesSwapped) {
            hoopColor = isLeft ? players[2].color : players[1].color;
        } else {
            hoopColor = isLeft ? players[1].color : players[2].color;
        }
        
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.fillRect(boardX, hoop.y - 50, 10, 75);
        
        ctx.strokeStyle = hoopColor;
        ctx.lineWidth = 2;
        ctx.strokeRect(boardX, hoop.y - 50, 10, 75);
        
        ctx.fillStyle = '#666';
        var poleX = isLeft ? 2 : width - 6;
        ctx.fillRect(poleX, hoop.y + 25, 5, height - hoop.y - 65);
    }
    
    function drawHoop(hoop) {
        var isLeft = hoop.side === 'left';
        var rimLeftX = isLeft ? hoop.x : hoop.x - hoop.width;
        var rimRightX = isLeft ? hoop.x + hoop.width : hoop.x;
        var centerX = (rimLeftX + rimRightX) / 2;
        var hoopColor;
        if (sidesSwapped) {
            hoopColor = isLeft ? players[2].color : players[1].color;
        } else {
            hoopColor = isLeft ? players[1].color : players[2].color;
        }
        
        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 1;
        var netSegments = 6;
        var bottomWidth = hoop.width * 0.5;
        var bottomLeftX = centerX - bottomWidth / 2;
        
        for (var i = 0; i <= netSegments; i++) {
            var topX = rimLeftX + (hoop.width / netSegments) * i;
            var bottomX = bottomLeftX + (bottomWidth / netSegments) * i;
            var wave = Math.sin(Date.now() * 0.003 + i) * 3;
            ctx.beginPath();
            ctx.moveTo(topX, hoop.y);
            ctx.quadraticCurveTo(topX + wave, hoop.y + hoop.netHeight * 0.6, bottomX + wave * 0.5, hoop.y + hoop.netHeight);
            ctx.stroke();
        }
        
        for (var j = 1; j <= 3; j++) {
            var t = j / 4;
            var rowY = hoop.y + hoop.netHeight * t;
            var rowWidth = hoop.width - (hoop.width - bottomWidth) * t;
            var rowLeftX = centerX - rowWidth / 2;
            var rowRightX = centerX + rowWidth / 2;
            ctx.beginPath();
            ctx.moveTo(rowLeftX, rowY);
            ctx.lineTo(rowRightX, rowY);
            ctx.stroke();
        }
        
        ctx.fillStyle = hoopColor;
        ctx.beginPath();
        ctx.arc(rimLeftX, hoop.y, hoop.rimRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(rimRightX, hoop.y, hoop.rimRadius, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.strokeStyle = hoopColor;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(rimLeftX, hoop.y);
        ctx.lineTo(rimRightX, hoop.y);
        ctx.stroke();
    }
    
    function drawAimArrow() {
        if (!isDragging || dragPoints.length < 2) return;
        
        var lastPoint = dragPoints[dragPoints.length - 1];
        var dx = lastPoint.x - dragStart.x;
        var dy = lastPoint.y - dragStart.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 10) return;
        
        var arrowLength = Math.min(dist * 1.5, 200);
        var angle = Math.atan2(dy, dx);
        
        var endX = ball.x + Math.cos(angle) * arrowLength;
        var endY = ball.y + Math.sin(angle) * arrowLength;
        
        var playerColor = players[currentPlayer].color;
        var gradient = ctx.createLinearGradient(ball.x, ball.y, endX, endY);
        gradient.addColorStop(0, playerColor);
        gradient.addColorStop(1, playerColor + '88');
        
        ctx.strokeStyle = gradient;
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(ball.x, ball.y);
        ctx.lineTo(endX, endY);
        ctx.stroke();
        
        var headLength = 18;
        var headAngle = 0.5;
        
        ctx.fillStyle = playerColor;
        ctx.beginPath();
        ctx.moveTo(endX, endY);
        ctx.lineTo(endX - headLength * Math.cos(angle - headAngle), endY - headLength * Math.sin(angle - headAngle));
        ctx.lineTo(endX - headLength * Math.cos(angle + headAngle), endY - headLength * Math.sin(angle + headAngle));
        ctx.closePath();
        ctx.fill();
        
        var numDots = Math.floor(arrowLength / 30);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        for (var i = 1; i <= numDots; i++) {
            var t = i / (numDots + 1);
            var dotX = ball.x + Math.cos(angle) * arrowLength * t;
            var dotY = ball.y + Math.sin(angle) * arrowLength * t;
            ctx.beginPath();
            ctx.arc(dotX, dotY, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        var power = Math.min(Math.round((dist / 200) * 100), 100);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(power + '%', ball.x, ball.y - ball.radius - 12);
    }
    
    function drawBallOffscreenIndicator() {
        if (ball.y + ball.radius < 0) {
            var distance = Math.abs(Math.round(ball.y));
            var indicatorX = Math.max(30, Math.min(width - 30, ball.x));
            
            ctx.fillStyle = players[currentPlayer].color;
            ctx.beginPath();
            ctx.moveTo(indicatorX, 20);
            ctx.lineTo(indicatorX - 15, 45);
            ctx.lineTo(indicatorX + 15, 45);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(distance + 'px', indicatorX, 62);
        }
    }
    
    function drawBall() {
        ctx.save();
        ctx.translate(ball.x, ball.y);
        ctx.rotate(ball.rotation);
        
        ctx.font = (ball.radius * 2) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üèÄ', 0, 0);
        
        ctx.restore();
    }
    
    function drawParticles() {
        for (var i = 0; i < particles.length; i++) {
            var p = particles[i];
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.globalAlpha = 1;
    }
    
    function drawScorePopups() {
        for (var i = 0; i < scorePopups.length; i++) {
            var s = scorePopups[i];
            ctx.globalAlpha = s.life;
            ctx.fillStyle = s.color;
            ctx.font = 'bold ' + Math.floor(40 * s.scale) + 'px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(s.text, s.x, s.y);
        }
        ctx.globalAlpha = 1;
    }
    
    function drawTurnover() {
        if (!showingTurnover) return;
        
        var elapsed = Date.now() - turnoverStartTime;
        
        var alpha;
        if (elapsed < 200) {
            alpha = elapsed / 200;
        } else if (elapsed > 800) {
            alpha = 1 - ((elapsed - 800) / 200);
        } else {
            alpha = 1;
        }
        
        var scale;
        if (elapsed < 200) {
            scale = 0.5 + (elapsed / 200) * 0.6;
        } else if (elapsed < 400) {
            scale = 1.1 - ((elapsed - 200) / 200) * 0.1;
        } else {
            scale = 1;
        }
        
        ctx.save();
        ctx.globalAlpha = alpha;
        
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(width / 2 - 150, height / 2 - 50, 300, 100);
        
        ctx.fillStyle = '#ff4444';
        ctx.font = 'bold ' + Math.floor(48 * scale) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('TURNOVER', width / 2, height / 2);
        
        ctx.fillStyle = players[currentPlayer].color;
        ctx.font = '18px Arial';
        ctx.fillText((currentPlayer === 1 ? p1Name : p2Name) + ' - Shot Clock Violation', width / 2, height / 2 + 35);
        
        ctx.restore();
    }
    
    function draw() {
        ctx.clearRect(0, 0, width, height);
        
        drawCourt();
        drawBackboard(hoopLeft);
        drawBackboard(hoopRight);
        drawParticles();
        drawHoop(hoopLeft);
        drawHoop(hoopRight);
        drawBall();
        drawBallOffscreenIndicator();
        drawAimArrow();
        drawScorePopups();
        drawShotClock();
        drawGameTimer();
        drawTurnover();
        drawHalftimeScreen();
        drawGameOverScreen();
    }
    
    var gameStarted = false;
    
    function drawStartScreen() {
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0, 0, width, height);
        
        ctx.fillStyle = 'white';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üèÄ Basketball with üèÄ', width / 2, height / 2 - 70);
        
        ctx.font = 'bold 52px Arial';
        ctx.fillStyle = '#ffd700';
        ctx.fillText('MALACHI', width / 2, height / 2 - 20);
        
        ctx.font = '24px Arial';
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.fillText('Tap anywhere to begin', width / 2, height / 2 + 40);
    }
    
    function handleCanvasClick(e) {
        var pos = getPos(e);
        
        if (!gameStarted) {
            settingsModal.classList.add('open');
            return;
        }
    }
    
    canvas.addEventListener('click', handleCanvasClick);
    
    function gameLoop() {
        update();
        draw();
        updateTopPanel();
        updateOverlays();
        if (!gameStarted) {
            drawStartScreen();
        }
        requestAnimationFrame(gameLoop);
    }
    
    positionHoops();
    gameLoop();
</script>

</body>
</html>
